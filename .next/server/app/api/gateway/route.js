"use strict";(()=>{var e={};e.id=72,e.ids=[72],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2615:e=>{e.exports=require("http")},8791:e=>{e.exports=require("https")},8216:e=>{e.exports=require("net")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},2452:e=>{e.exports=require("tls")},7360:e=>{e.exports=require("url")},1568:e=>{e.exports=require("zlib")},5862:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>_,patchFetch:()=>m,requestAsyncStorage:()=>f,routeModule:()=>p,serverHooks:()=>g,staticGenerationAsyncStorage:()=>w});var a={};r.r(a),r.d(a,{GET:()=>u,PATCH:()=>c,POST:()=>l});var s=r(9303),n=r(8716),i=r(670),o=r(7070),d=r(5456);async function u(e){try{let t=await (0,d.h3)(e);if(!t.authenticated||!t.userId)return(0,d.m)(t.error);let{searchParams:r}=new URL(e.url),a=r.get("studentId")||t.userId;if(!(0,d.ni)(a))return(0,d.ks)("Invalid studentId");if(a!==t.userId&&"teacher"!==t.role)return(0,d.Py)("Cannot view another student's gateway status");let s=(0,d.bQ)(),{data:n,error:i}=await s.from("users").select("gateway_complete, gateway_completed_at, tier_level").eq("id",a).single();if(i)throw i;let{data:u}=await s.from("gateway_challenges").select("status, submitted_at, review_feedback").eq("student_id",a).single();return o.NextResponse.json({gatewayComplete:n?.gateway_complete||!1,completedAt:n?.gateway_completed_at,tierLevel:n?.tier_level||0,challengeStatus:u?.status,submittedAt:u?.submitted_at,feedback:u?.review_feedback})}catch(e){return console.error("[GATEWAY] GET error:",e instanceof Error?e.message:"Unknown"),(0,d.Vd)("Failed to check gateway status")}}async function l(e){try{let t;let r=await (0,d.h3)(e);if(!r.authenticated||!r.userId)return(0,d.m)(r.error);let a=(0,d.Dn)(`gateway:${r.userId}`,d.fp.write);if(!a.allowed)return(0,d.tm)(a.resetIn);try{t=await e.json()}catch{return(0,d.ks)("Invalid JSON body")}let{studentId:s,recipientDescription:n,messageType:i,messagePreview:u,proofUrl:l,reflection:c}=t;if(!(0,d.ni)(s))return(0,d.ks)("Invalid studentId");if(!(0,d.Cp)(n,500)||!(0,d.Cp)(i,50))return(0,d.ks)("Invalid recipientDescription or messageType");if(!(0,d.Cp)(c,2e3))return(0,d.ks)("Invalid reflection");if(s!==r.userId)return(0,d.Py)("Cannot submit gateway challenge for another user");let p=(0,d.bQ)(),{data:f}=await p.from("gateway_challenges").select("id, status").eq("student_id",s).single();if(f)return o.NextResponse.json({error:"Gateway challenge already submitted",status:f.status},{status:400});let{data:w,error:g}=await p.from("gateway_challenges").insert({student_id:s,challenge_type:"gratitude",recipient_description:n.slice(0,500),message_type:i.slice(0,50),message_preview:u?.slice(0,1e3),proof_url:l?.slice(0,500),reflection:c.slice(0,2e3),status:"pending"}).select().single();if(g)throw g;return o.NextResponse.json({success:!0,challenge:w,message:"Gateway challenge submitted for review"})}catch(e){return console.error("[GATEWAY] POST error:",e instanceof Error?e.message:"Unknown"),(0,d.Vd)("Failed to submit gateway challenge")}}async function c(e){try{let t;let r=await (0,d.h3)(e);if(!r.authenticated||!r.userId)return(0,d.m)(r.error);if("teacher"!==r.role)return(0,d.Py)("Only teachers can review gateway challenges");try{t=await e.json()}catch{return(0,d.ks)("Invalid JSON body")}let{challengeId:a,teacherId:s,status:n,feedback:i}=t;if(!(0,d.ni)(a))return(0,d.ks)("Invalid challengeId");if(!["approved","needs_revision"].includes(n))return(0,d.ks)("Invalid status");if(s&&s!==r.userId)return(0,d.Py)("Cannot approve as another teacher");let u=(0,d.bQ)(),{data:l,error:c}=await u.from("gateway_challenges").update({status:n,reviewed_by:r.userId,reviewed_at:new Date().toISOString(),review_feedback:i?.slice(0,1e3),completed_at:"approved"===n?new Date().toISOString():null}).eq("id",a).select("student_id").single();if(c)throw c;if("approved"===n&&l){let{error:e}=await u.from("users").update({gateway_complete:!0,gateway_completed_at:new Date().toISOString(),tier_level:1}).eq("id",l.student_id);e&&console.error("[GATEWAY] User update failed:",e.message);try{await u.from("world_states").upsert({student_id:l.student_id,trees:0,flowers:1,stones:0,crystals:0,tower:0,bridge:0},{onConflict:"student_id"})}catch(e){console.error("[GATEWAY] World state upsert failed:",e)}(async()=>{try{let{data:e}=await u.from("users").select("class_id").eq("id",l.student_id).single();e?.class_id&&await u.rpc("add_to_feed",{p_class_id:e.class_id,p_student_id:l.student_id,p_activity_type:"gateway_complete",p_description:"Completed the Gateway Challenge and entered their world",p_related_id:a,p_related_type:"gateway"})}catch(e){console.error("[GATEWAY] Feed insert failed:",e)}})(),(async()=>{try{await u.from("discovered_secrets").insert({student_id:l.student_id,secret_type:"memory_stone",secret_name:"Memory Stone"})}catch(e){console.error("[GATEWAY] Secret insert failed:",e)}})()}return o.NextResponse.json({success:!0,status:n,message:"approved"===n?"Gateway approved! Student world unlocked.":"Revision requested"})}catch(e){return console.error("[GATEWAY] PATCH error:",e instanceof Error?e.message:"Unknown"),(0,d.Vd)("Failed to review gateway challenge")}}let p=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/gateway/route",pathname:"/api/gateway",filename:"route",bundlePath:"app/api/gateway/route"},resolvedPagePath:"/workspace/leadership-platform/src/app/api/gateway/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:f,staticGenerationAsyncStorage:w,serverHooks:g}=p,_="/api/gateway/route";function m(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:w})}},5456:(e,t,r)=>{r.d(t,{Cp:()=>y,Dn:()=>_,M2:()=>f,Py:()=>l,Vd:()=>p,bQ:()=>i,fp:()=>g,h3:()=>o,ks:()=>c,m:()=>u,ni:()=>h,oN:()=>d,tm:()=>m});var a=r(7070),s=r(2814);let n=null;function i(){if(n)return n;let e=process.env.NEXT_PUBLIC_SUPABASE_URL,t=process.env.SUPABASE_SERVICE_ROLE_KEY||process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;if(!e||!t)throw Error("FATAL: Missing Supabase configuration. Set NEXT_PUBLIC_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY environment variables.");return n=(0,s.eI)(e,t)}async function o(e){try{let t=i(),r=new URL(e.url),a=r.searchParams.get("studentId")||r.searchParams.get("userId");if(!a&&("POST"===e.method||"PATCH"===e.method))try{let t=await e.clone().json();a=t.studentId||t.userId||t.teacherId}catch{}if(!a)return{authenticated:!1,error:"No user identifier provided"};if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(a))return{authenticated:!1,error:"Invalid user identifier format"};let{data:s,error:n}=await t.from("users").select("id, role, class_id").eq("id",a).single();if(n||!s)return{authenticated:!1,error:"User not found"};return{authenticated:!0,userId:s.id,role:s.role,classId:s.class_id}}catch(e){return console.error("[AUTH] Validation error:",e instanceof Error?e.message:"Unknown"),{authenticated:!1,error:"Authentication failed"}}}async function d(e,t){try{let r=i(),{data:a}=await r.from("users").select("class_id").eq("id",e).single();return a?.class_id===t}catch{return!1}}function u(e="Unauthorized"){return a.NextResponse.json({error:e},{status:401})}function l(e="Forbidden"){return a.NextResponse.json({error:e},{status:403})}function c(e){return a.NextResponse.json({error:e},{status:400})}function p(e="Internal server error"){return a.NextResponse.json({error:e},{status:500})}function f(e){return a.NextResponse.json({error:e},{status:503})}let w=new Map,g={ai:{windowMs:6e4,maxRequests:10},standard:{windowMs:6e4,maxRequests:60},write:{windowMs:6e4,maxRequests:30}};function _(e,t=g.standard){let r=Date.now();w.size>1e4&&w.forEach((e,t)=>{e.resetAt<r&&w.delete(t)});let a=w.get(e);return!a||a.resetAt<r?(w.set(e,{count:1,resetAt:r+t.windowMs}),{allowed:!0,remaining:t.maxRequests-1,resetIn:t.windowMs}):a.count>=t.maxRequests?{allowed:!1,remaining:0,resetIn:a.resetAt-r}:(a.count++,{allowed:!0,remaining:t.maxRequests-a.count,resetIn:a.resetAt-r})}function m(e){return a.NextResponse.json({error:"Too many requests. Please slow down."},{status:429,headers:{"Retry-After":String(Math.ceil(e/1e3)),"X-RateLimit-Reset":String(Math.ceil(e/1e3))}})}function h(e){return"string"==typeof e&&/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}function y(e,t=1e4){return"string"==typeof e&&e.length>0&&e.length<=t}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[276,505],()=>r(5862));module.exports=a})();