"use strict";(()=>{var e={};e.id=72,e.ids=[72],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2615:e=>{e.exports=require("http")},5240:e=>{e.exports=require("https")},8216:e=>{e.exports=require("net")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},2452:e=>{e.exports=require("tls")},7360:e=>{e.exports=require("url")},1568:e=>{e.exports=require("zlib")},9864:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>g,patchFetch:()=>y,requestAsyncStorage:()=>f,routeModule:()=>p,serverHooks:()=>h,staticGenerationAsyncStorage:()=>w});var a={};r.r(a),r.d(a,{GET:()=>d,PATCH:()=>c,POST:()=>l});var s=r(9919),n=r(7665),i=r(8747),o=r(8635),u=r(4596);async function d(e){try{let t=await (0,u.h3)(e);if(!t.authenticated||!t.userId)return(0,u.m)(t.error);let{searchParams:r}=new URL(e.url),a=r.get("studentId")||t.userId;if(!(0,u.ni)(a))return(0,u.ks)("Invalid studentId");if(a!==t.userId&&"teacher"!==t.role)return(0,u.Py)("Cannot view another student's gateway status");let s=(0,u.bQ)(),{data:n,error:i}=await s.from("users").select("gateway_complete, gateway_completed_at, tier_level").eq("id",a).single();if(i)throw i;let{data:d}=await s.from("gateway_challenges").select("status, submitted_at, review_feedback").eq("student_id",a).single();return o.NextResponse.json({gatewayComplete:n?.gateway_complete||!1,completedAt:n?.gateway_completed_at,tierLevel:n?.tier_level||0,challengeStatus:d?.status,submittedAt:d?.submitted_at,feedback:d?.review_feedback})}catch(e){return console.error("[GATEWAY] GET error:",e instanceof Error?e.message:"Unknown"),(0,u.Vd)("Failed to check gateway status")}}async function l(e){try{let t;let r=await (0,u.h3)(e);if(!r.authenticated||!r.userId)return(0,u.m)(r.error);let a=(0,u.Dn)(`gateway:${r.userId}`,u.fp.write);if(!a.allowed)return(0,u.tm)(a.resetIn);try{t=await e.json()}catch{return(0,u.ks)("Invalid JSON body")}let{studentId:s,recipientDescription:n,messageType:i,messagePreview:d,proofUrl:l,reflection:c}=t;if(!(0,u.ni)(s))return(0,u.ks)("Invalid studentId");if(!(0,u.Cp)(n,500)||!(0,u.Cp)(i,50))return(0,u.ks)("Invalid recipientDescription or messageType");if(!(0,u.Cp)(c,2e3))return(0,u.ks)("Invalid reflection");if(s!==r.userId)return(0,u.Py)("Cannot submit gateway challenge for another user");let p=(0,u.bQ)(),{data:f}=await p.from("gateway_challenges").select("id, status").eq("student_id",s).single();if(f)return o.NextResponse.json({error:"Gateway challenge already submitted",status:f.status},{status:400});let{data:w,error:h}=await p.from("gateway_challenges").insert({student_id:s,challenge_type:"gratitude",recipient_description:n.slice(0,500),message_type:i.slice(0,50),message_preview:d?.slice(0,1e3),proof_url:l?.slice(0,500),reflection:c.slice(0,2e3),status:"pending"}).select().single();if(h)throw h;return o.NextResponse.json({success:!0,challenge:w,message:"Gateway challenge submitted for review"})}catch(e){return console.error("[GATEWAY] POST error:",e instanceof Error?e.message:"Unknown"),(0,u.Vd)("Failed to submit gateway challenge")}}async function c(e){try{let t;let r=await (0,u.h3)(e);if(!r.authenticated||!r.userId)return(0,u.m)(r.error);if("teacher"!==r.role)return(0,u.Py)("Only teachers can review gateway challenges");try{t=await e.json()}catch{return(0,u.ks)("Invalid JSON body")}let{challengeId:a,teacherId:s,status:n,feedback:i}=t;if(!(0,u.ni)(a))return(0,u.ks)("Invalid challengeId");if(!["approved","needs_revision"].includes(n))return(0,u.ks)("Invalid status");if(s&&s!==r.userId)return(0,u.Py)("Cannot approve as another teacher");let d=(0,u.bQ)(),{data:l,error:c}=await d.from("gateway_challenges").update({status:n,reviewed_by:r.userId,reviewed_at:new Date().toISOString(),review_feedback:i?.slice(0,1e3),completed_at:"approved"===n?new Date().toISOString():null}).eq("id",a).select("student_id").single();if(c)throw c;if("approved"===n&&l){let{error:e}=await d.from("users").update({gateway_complete:!0,gateway_completed_at:new Date().toISOString(),tier_level:1}).eq("id",l.student_id);e&&console.error("[GATEWAY] User update failed:",e.message);try{await d.from("world_states").upsert({student_id:l.student_id,trees:0,flowers:1,stones:0,crystals:0,tower:0,bridge:0},{onConflict:"student_id"})}catch(e){console.error("[GATEWAY] World state upsert failed:",e)}(async()=>{try{let{data:e}=await d.from("users").select("class_id").eq("id",l.student_id).single();e?.class_id&&await d.rpc("add_to_feed",{p_class_id:e.class_id,p_student_id:l.student_id,p_activity_type:"gateway_complete",p_description:"Completed the Gateway Challenge and entered their world",p_related_id:a,p_related_type:"gateway"})}catch(e){console.error("[GATEWAY] Feed insert failed:",e)}})(),(async()=>{try{await d.from("discovered_secrets").insert({student_id:l.student_id,secret_type:"memory_stone",secret_name:"Memory Stone"})}catch(e){console.error("[GATEWAY] Secret insert failed:",e)}})()}return o.NextResponse.json({success:!0,status:n,message:"approved"===n?"Gateway approved! Student world unlocked.":"Revision requested"})}catch(e){return console.error("[GATEWAY] PATCH error:",e instanceof Error?e.message:"Unknown"),(0,u.Vd)("Failed to review gateway challenge")}}let p=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/gateway/route",pathname:"/api/gateway",filename:"route",bundlePath:"app/api/gateway/route"},resolvedPagePath:"/workspace/leadership-platform/src/app/api/gateway/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:f,staticGenerationAsyncStorage:w,serverHooks:h}=p,g="/api/gateway/route";function y(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:w})}},4596:(e,t,r)=>{r.d(t,{Cp:()=>v,Dn:()=>m,Gu:()=>d,M2:()=>h,Py:()=>p,Vd:()=>w,bQ:()=>o,fp:()=>y,h3:()=>u,ks:()=>f,m:()=>c,ni:()=>I,oN:()=>l,pG:()=>x,tm:()=>_,uw:()=>i,vJ:()=>A});var a=r(8635),s=r(2380);function n(){let e="https://apakkhzuydsfzvypewwa.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Missing Supabase service configuration");return(0,s.eI)(e,t)}function i(e){let t="https://apakkhzuydsfzvypewwa.supabase.co",r="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwYWtraHp1eWRzZnp2eXBld3dhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1MDEyODQsImV4cCI6MjA4NDA3NzI4NH0.c3hiZOEKMIXMP7aB0SVgrbQH58nwxseycVmeH23KsNQ";if(!t||!r)throw Error("Missing Supabase configuration");let a=e.headers.get("Authorization");return(0,s.eI)(t,r,{global:{headers:a?{Authorization:a}:{}}})}let o=n;async function u(e){try{let t=i(e),{data:{user:r},error:a}=await t.auth.getUser();if(a||!r)return{authenticated:!1,error:"Invalid or expired session"};let{data:s,error:n}=await t.from("users").select("id, role, class_id").eq("id",r.id).single();if(n||!s)return{authenticated:!1,error:"User profile not found"};return{authenticated:!0,userId:r.id,role:s.role,classId:s.class_id}}catch(e){return console.error("[AUTH] Validation error:",e instanceof Error?e.message:"Unknown"),{authenticated:!1,error:"Authentication failed"}}}async function d(e){let t=await u(e);if(t.authenticated)return"student"!==t.role?{authenticated:!1,error:"Student access required"}:t;try{let t=await e.clone().json(),r=t?.student_id;if(!r||!I(r))return{authenticated:!1,error:"Invalid or expired session"};let a=n(),{data:s,error:i}=await a.from("users").select("id, role, class_id").eq("id",r).eq("role","student").single();if(i||!s)return{authenticated:!1,error:"Student not found"};return{authenticated:!0,userId:s.id,role:"student",classId:s.class_id}}catch{return{authenticated:!1,error:"Authentication failed"}}}async function l(e,t){let r=await u(e);if(!r.authenticated)return r;if("teacher"===r.role){let a=i(e),{data:s}=await a.from("classes").select("id").eq("id",t).eq("teacher_id",r.userId).single();if(!s)return{authenticated:!1,error:"Not authorized for this class"}}else if(r.classId!==t)return{authenticated:!1,error:"Not authorized for this class"};return r}function c(e="Unauthorized"){return a.NextResponse.json({error:e},{status:401})}function p(e="Forbidden"){return a.NextResponse.json({error:e},{status:403})}function f(e){return a.NextResponse.json({error:e},{status:400})}function w(e="Internal server error"){return a.NextResponse.json({error:e},{status:500})}function h(e){return a.NextResponse.json({error:e},{status:503})}let g=new Map,y={ai:{windowMs:6e4,maxRequests:10},standard:{windowMs:6e4,maxRequests:60},write:{windowMs:6e4,maxRequests:30}};function m(e,t=y.standard){let r=Date.now();g.size>1e4&&g.forEach((e,t)=>{e.resetAt<r&&g.delete(t)});let a=g.get(e);return!a||a.resetAt<r?(g.set(e,{count:1,resetAt:r+t.windowMs}),{allowed:!0,remaining:t.maxRequests-1,resetIn:t.windowMs}):a.count>=t.maxRequests?{allowed:!1,remaining:0,resetIn:a.resetAt-r}:(a.count++,{allowed:!0,remaining:t.maxRequests-a.count,resetIn:a.resetAt-r})}function _(e){return a.NextResponse.json({error:"Too many requests. Please slow down."},{status:429,headers:{"Retry-After":String(Math.ceil(e/1e3)),"X-RateLimit-Reset":String(Math.ceil(e/1e3))}})}function I(e){return"string"==typeof e&&/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}function v(e,t=5e3){if("string"!=typeof e)return!1;let r=e.trim();return r.length>0&&r.length<=t}function x(e){return"string"==typeof e&&["do_now","scenario","challenge","exit_ticket"].includes(e)}function A(e){return e.replace(/<[^>]*>/g,"").replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"").trim()}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[469,16],()=>r(9864));module.exports=a})();