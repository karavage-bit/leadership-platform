"use strict";(()=>{var e={};e.id=451,e.ids=[451],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2048:e=>{e.exports=require("fs")},2615:e=>{e.exports=require("http")},8791:e=>{e.exports=require("https")},8216:e=>{e.exports=require("net")},5315:e=>{e.exports=require("path")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},2452:e=>{e.exports=require("tls")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},2623:e=>{e.exports=require("worker_threads")},1568:e=>{e.exports=require("zlib")},7561:e=>{e.exports=require("node:fs")},4492:e=>{e.exports=require("node:stream")},2477:e=>{e.exports=require("node:stream/web")},413:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>w,patchFetch:()=>b,requestAsyncStorage:()=>m,routeModule:()=>f,serverHooks:()=>y,staticGenerationAsyncStorage:()=>g});var s={};r.r(s),r.d(s,{POST:()=>p});var n=r(9303),o=r(8716),a=r(670),i=r(7070),u=r(672),l=r(5456);let c=null,h={self_harm:[/\b(kill myself|want to die|end it all|suicide|self.?harm|hurt myself|cutting)\b/i,/\b(no point in living|better off dead|don't want to be here|disappear forever)\b/i],helplessness:[/\b(no hope|hopeless|can't go on|give up on everything|nothing matters)\b/i,/\b(no one cares|completely alone|nobody would notice)\b/i],rage:[/\b(kill (them|him|her|someone)|hurt (them|him|her|someone)|violent thoughts)\b/i,/\b(want to destroy|burn it down|make them pay)\b/i],abuse:[/\b(being hit|beats me|touches me|abuse|molest|assault)\b/i,/\b(scared to go home|parents hurt me|forced to)\b/i]},d=[/\b(as an AI|I cannot|I'm designed to)\b/i,/\b(certainly|absolutely|definitely|obviously)\b.*\b(important|crucial|vital)\b/i,/\b(firstly|secondly|thirdly|in conclusion|to summarize)\b/i,/it's (important|crucial|essential) to (note|remember|understand)/i];async function p(e){let t=function(){if(c)return c;let e=process.env.ANTHROPIC_API_KEY;return e?c=new u.ZP({apiKey:e}):(console.error("[SOCRATIC] ANTHROPIC_API_KEY not configured"),null)}();if(!t)return(0,l.M2)("AI service not configured. Please contact your teacher.");try{let r,s;let n=await (0,l.h3)(e);if(!n.authenticated||!n.userId)return(0,l.m)(n.error);let o=(0,l.Dn)(`ai:${n.userId}`,l.fp.ai);if(!o.allowed)return(0,l.tm)(o.resetIn);try{r=await e.json()}catch{return i.NextResponse.json({error:"Invalid JSON body"},{status:400})}let{type:a,lesson_id:u,student_id:c,class_id:p,conversation_history:f,user_message:m,lesson_context:g,response_count:y,min_responses:w}=r;if(!(0,l.ni)(c))return i.NextResponse.json({error:"Invalid student_id"},{status:400});if(!(0,l.ni)(p))return i.NextResponse.json({error:"Invalid class_id"},{status:400});if(!(0,l.Cp)(m,5e3))return i.NextResponse.json({error:"Invalid or too long message"},{status:400});if(!Array.isArray(f)||f.length>20)return i.NextResponse.json({error:"Invalid conversation history"},{status:400});if("number"!=typeof y||y<0||y>100)return i.NextResponse.json({error:"Invalid response_count"},{status:400});if("number"!=typeof w||w<1||w>20)return i.NextResponse.json({error:"Invalid min_responses"},{status:400});let b=(0,l.bQ)(),A=function(e){for(let[t,r]of Object.entries(h))for(let s of r){let r=e.match(s);if(r)return{detected:!0,type:t,trigger:r[0]}}return{detected:!1,type:null,trigger:null}}(m);if(A.detected)return(async()=>{try{await b.from("crisis_alerts").insert({student_id:c,class_id:p,lesson_id:u,trigger_type:A.type,trigger_text:A.trigger,conversation_context:f.slice(-5),status:"unread"})}catch(e){console.error("[SOCRATIC] Crisis alert insert failed:",e)}})(),i.NextResponse.json({message:`I need to pause here. What you just shared sounds really difficult, and I want you to know that you're not alone. 

Please talk to your teacher, school counselor, or another trusted adult about what you're going through. They want to help.

If you're in crisis right now, please text HOME to 741741 (Crisis Text Line) or call 988 (Suicide & Crisis Lifeline).

We can continue our conversation after you've had a chance to talk to someone. You matter. ðŸ’™`,crisis_detected:!0,should_complete:!1});let x=m.trim().split(/\s+/).length<5||!!["idk","i dont know","sure","ok","okay","fine","whatever","idc","maybe","probably","i guess"].includes(m.toLowerCase().trim()),E=function(e){for(let t of d)if(t.test(e))return!0;return!1}(m);if(x&&y<w)return i.NextResponse.json({message:"That's not enough for me to work with. I need at least a full sentence with your actual thoughts. What are you really thinking?",should_complete:!1});if(E)return i.NextResponse.json({message:"Hold up â€” that reads like it was generated by AI or copied from somewhere. I need YOUR words, YOUR thoughts. Even if they're messy or uncertain. What do YOU actually think about this?",should_complete:!1});let I=g?.skill_name||"leadership",R=g?.compelling_question||"this topic",v={do_now:`You are a Socratic guide for a high school leadership class. Your role is to help students think deeply about today's skill: "${I}".

CORE PRINCIPLES (Anti-Sycophancy):
- NEVER say "Great job!" "That's perfect!" "Exactly right!" or similar praise
- NEVER accept surface-level answers - always push for depth
- Use the Socratic method: ask questions that reveal assumptions and require deeper thinking
- Keep students in Zone 2 (productive struggle) - not too easy, not overwhelming
- If the student gives a generic answer, push back: "That sounds like what you think I want to hear. What do YOU actually think?"

YOUR GOAL:
- Help them genuinely wrestle with the question: "${R}"
- Get them thinking about how this skill shows up in THEIR life
- After ${w} meaningful exchanges, summarize what they discovered and wrap up

RESPONSE STYLE:
- Brief and conversational (2-4 sentences max)
- Ask ONE focused question at a time
- Reference what they said specifically
- Gently challenge without being harsh

COMPLETION:
After ${w}+ genuine exchanges where the student showed real thinking, you can close with a brief synthesis of what they explored. Add [COMPLETE] at the end of your message when ready to wrap up.`,scenario:`You are a Socratic coach presenting a real-life scenario that requires the skill: "${I}".

THE SCENARIO APPROACH:
1. First exchange: Present a realistic, relatable situation relevant to high school students
2. Ask: "What would you do?" or "How would you handle this?"
3. Whatever they say: Push back with complications, consequences, or "What if..." challenges
4. Make them justify their choices and consider alternatives
5. After ${w}+ exchanges with genuine struggle, help them articulate a plan

ANTI-SYCOPHANCY RULES:
- NEVER accept easy answers
- NEVER say "That's a great approach!" - instead say "And what happens when..."
- Challenge every decision with realistic complications
- If they give a textbook answer, say: "That's what you'd tell a teacher. What would you ACTUALLY do?"

ZONE 2 MANAGEMENT:
- Push them to think harder, but watch for frustration
- If they seem overwhelmed, acknowledge the difficulty but don't solve it for them
- Goal: They should feel like they figured something out on their own

COMPLETION:
After substantive exchanges, help them crystallize what they learned into an action plan. Add [COMPLETE] at the end.`,exit_ticket:`You are a reflective guide helping a student process what they learned about "${I}".

YOUR ROLE:
- Help them identify ONE concrete takeaway
- Connect the lesson to their real life
- Keep it brief - this is end-of-class reflection

APPROACH:
- Ask what stuck with them
- Ask how they might apply it
- After 3-4 exchanges, summarize and close

Add [COMPLETE] when finished.`},k=v[a]||v.do_now,_=f.filter(e=>e&&"string"==typeof e.role&&"string"==typeof e.content).map(e=>({role:"assistant"===e.role?"assistant":"user",content:String(e.content).slice(0,5e3)}));_.push({role:"user",content:m});let P=new AbortController,C=setTimeout(()=>P.abort(),25e3);try{s=await t.messages.create({model:"claude-sonnet-4-20250514",max_tokens:500,system:k,messages:_},{signal:P.signal})}catch(e){if("AbortError"===e.name)return i.NextResponse.json({message:"I'm thinking hard about this one! The response is taking longer than usual. Please try again.",should_complete:!1});return console.error("[SOCRATIC] Anthropic API error:",e.message||"Unknown"),(0,l.Vd)("AI service temporarily unavailable. Please try again.")}finally{clearTimeout(C)}let N="text"===s.content[0].type?s.content[0].text:"",O=N.includes("[COMPLETE]")&&y>=w-1,T=N.replace("[COMPLETE]","").trim(),S=new Date().toISOString().split("T")[0];return(async()=>{try{await b.rpc("increment_ai_usage",{p_student_id:c,p_date:S})}catch(e){console.error("[SOCRATIC] Usage tracking failed:",e)}})(),i.NextResponse.json({message:T,should_complete:O,response_count:y+1})}catch(e){return console.error("[SOCRATIC] Unexpected error:",e.message||"Unknown"),(0,l.Vd)("An unexpected error occurred. Please try again.")}}let f=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/ai/socratic/route",pathname:"/api/ai/socratic",filename:"route",bundlePath:"app/api/ai/socratic/route"},resolvedPagePath:"/workspace/leadership-platform/src/app/api/ai/socratic/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:y}=f,w="/api/ai/socratic/route";function b(){return(0,a.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:g})}},5456:(e,t,r)=>{r.d(t,{Cp:()=>b,Dn:()=>g,M2:()=>p,Py:()=>c,Vd:()=>d,bQ:()=>a,fp:()=>m,h3:()=>i,ks:()=>h,m:()=>l,ni:()=>w,oN:()=>u,tm:()=>y});var s=r(7070),n=r(2814);let o=null;function a(){if(o)return o;let e=process.env.NEXT_PUBLIC_SUPABASE_URL,t=process.env.SUPABASE_SERVICE_ROLE_KEY||process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;if(!e||!t)throw Error("FATAL: Missing Supabase configuration. Set NEXT_PUBLIC_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY environment variables.");return o=(0,n.eI)(e,t)}async function i(e){try{let t=a(),r=new URL(e.url),s=r.searchParams.get("studentId")||r.searchParams.get("userId");if(!s&&("POST"===e.method||"PATCH"===e.method))try{let t=await e.clone().json();s=t.studentId||t.userId||t.teacherId}catch{}if(!s)return{authenticated:!1,error:"No user identifier provided"};if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s))return{authenticated:!1,error:"Invalid user identifier format"};let{data:n,error:o}=await t.from("users").select("id, role, class_id").eq("id",s).single();if(o||!n)return{authenticated:!1,error:"User not found"};return{authenticated:!0,userId:n.id,role:n.role,classId:n.class_id}}catch(e){return console.error("[AUTH] Validation error:",e instanceof Error?e.message:"Unknown"),{authenticated:!1,error:"Authentication failed"}}}async function u(e,t){try{let r=a(),{data:s}=await r.from("users").select("class_id").eq("id",e).single();return s?.class_id===t}catch{return!1}}function l(e="Unauthorized"){return s.NextResponse.json({error:e},{status:401})}function c(e="Forbidden"){return s.NextResponse.json({error:e},{status:403})}function h(e){return s.NextResponse.json({error:e},{status:400})}function d(e="Internal server error"){return s.NextResponse.json({error:e},{status:500})}function p(e){return s.NextResponse.json({error:e},{status:503})}let f=new Map,m={ai:{windowMs:6e4,maxRequests:10},standard:{windowMs:6e4,maxRequests:60},write:{windowMs:6e4,maxRequests:30}};function g(e,t=m.standard){let r=Date.now();f.size>1e4&&f.forEach((e,t)=>{e.resetAt<r&&f.delete(t)});let s=f.get(e);return!s||s.resetAt<r?(f.set(e,{count:1,resetAt:r+t.windowMs}),{allowed:!0,remaining:t.maxRequests-1,resetIn:t.windowMs}):s.count>=t.maxRequests?{allowed:!1,remaining:0,resetIn:s.resetAt-r}:(s.count++,{allowed:!0,remaining:t.maxRequests-s.count,resetIn:s.resetAt-r})}function y(e){return s.NextResponse.json({error:"Too many requests. Please slow down."},{status:429,headers:{"Retry-After":String(Math.ceil(e/1e3)),"X-RateLimit-Reset":String(Math.ceil(e/1e3))}})}function w(e){return"string"==typeof e&&/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}function b(e,t=1e4){return"string"==typeof e&&e.length>0&&e.length<=t}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[276,505,672],()=>r(413));module.exports=s})();