"use strict";(()=>{var e={};e.id=839,e.ids=[839],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2615:e=>{e.exports=require("http")},5240:e=>{e.exports=require("https")},8216:e=>{e.exports=require("net")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},2452:e=>{e.exports=require("tls")},7360:e=>{e.exports=require("url")},1568:e=>{e.exports=require("zlib")},9691:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>m,patchFetch:()=>y,requestAsyncStorage:()=>f,routeModule:()=>p,serverHooks:()=>_,staticGenerationAsyncStorage:()=>h});var s={};r.r(s),r.d(s,{GET:()=>u,PATCH:()=>l,POST:()=>c});var n=r(9919),i=r(7665),o=r(8747),a=r(8635),d=r(4596);async function u(e){try{let t=await (0,d.h3)(e);if(!t.authenticated||!t.userId)return(0,d.m)(t.error);let{searchParams:r}=new URL(e.url),s=r.get("classId"),n=r.get("studentId")||t.userId,i=Math.min(parseInt(r.get("limit")||"20"),100);if(!s||!(0,d.ni)(s))return(0,d.ks)("Missing or invalid classId");if(!await (0,d.oN)(t.userId,s))return(0,d.Py)("You do not have access to this class");let o=(0,d.bQ)(),{data:u,error:c}=await o.from("student_discoveries").select(`
        id,
        student_id,
        title,
        source_type,
        source_name,
        content_url,
        description,
        leadership_connection,
        related_skills,
        image_url,
        helpful_count,
        comment_count,
        show_author,
        created_at,
        users!student_id (
          name,
          anonymous_name,
          is_unmasked
        )
      `).eq("class_id",s).eq("status","approved").order("created_at",{ascending:!1}).limit(i);if(c)throw c;let l=[];if(n){let{data:e}=await o.from("discovery_helpful").select("discovery_id").eq("student_id",n);l=e?.map(e=>e.discovery_id)||[]}let p=u?.map(e=>({id:e.id,authorName:e.show_author&&e.users?.is_unmasked?e.users?.name:e.users?.anonymous_name||"Anonymous",isUnmasked:e.show_author&&e.users?.is_unmasked,title:e.title,sourceType:e.source_type,sourceName:e.source_name,contentUrl:e.content_url,description:e.description,leadershipConnection:e.leadership_connection,relatedSkills:e.related_skills||[],imageUrl:e.image_url,helpfulCount:e.helpful_count||0,commentCount:e.comment_count||0,hasVoted:l.includes(e.id),createdAt:e.created_at}))||[];return a.NextResponse.json({discoveries:p})}catch(e){return console.error("[DISCOVERIES] GET error:",e instanceof Error?e.message:"Unknown"),(0,d.Vd)("Failed to fetch discoveries")}}async function c(e){try{let t;let r=await (0,d.h3)(e);if(!r.authenticated||!r.userId)return(0,d.m)(r.error);let s=(0,d.Dn)(`discovery:${r.userId}`,d.fp.write);if(!s.allowed)return(0,d.tm)(s.resetIn);try{t=await e.json()}catch{return(0,d.ks)("Invalid JSON body")}let{studentId:n,classId:i,title:o,sourceType:u,sourceName:c,contentUrl:l,description:p,leadershipConnection:f,relatedSkills:h,imageUrl:_}=t;if(!(0,d.ni)(n)||!(0,d.ni)(i))return(0,d.ks)("Invalid studentId or classId");if(!(0,d.Cp)(o,200)||!(0,d.Cp)(u,50))return(0,d.ks)("Invalid title or sourceType");if(!(0,d.Cp)(p,2e3)||!(0,d.Cp)(f,1e3))return(0,d.ks)("Invalid description or leadershipConnection");if(n!==r.userId)return(0,d.Py)("Cannot create discovery for another user");if(!await (0,d.oN)(r.userId,i))return(0,d.Py)("You do not have access to this class");let m=(0,d.bQ)(),{data:y,error:v}=await m.from("student_discoveries").insert({student_id:n,class_id:i,title:o.slice(0,200),source_type:u.slice(0,50),source_name:c?.slice(0,200),content_url:l?.slice(0,500),description:p.slice(0,2e3),leadership_connection:f.slice(0,1e3),related_skills:Array.isArray(h)?h.slice(0,10):[],image_url:_?.slice(0,500),status:"pending"}).select().single();if(v)throw v;return(async()=>{try{await m.rpc("add_to_feed",{p_class_id:i,p_student_id:n,p_activity_type:"discovery_posted",p_description:`Shared a discovery: "${o.slice(0,50)}"`,p_related_id:y.id,p_related_type:"discovery"})}catch(e){console.error("[DISCOVERIES] Feed insert failed:",e)}})(),a.NextResponse.json({success:!0,discovery:y,message:"Discovery submitted for review"})}catch(e){return console.error("[DISCOVERIES] POST error:",e instanceof Error?e.message:"Unknown"),(0,d.Vd)("Failed to create discovery")}}async function l(e){try{let t;let r=await (0,d.h3)(e);if(!r.authenticated||!r.userId)return(0,d.m)(r.error);let s=(0,d.Dn)(`vote:${r.userId}`,d.fp.write);if(!s.allowed)return(0,d.tm)(s.resetIn);try{t=await e.json()}catch{return(0,d.ks)("Invalid JSON body")}let{discoveryId:n,studentId:i,action:o}=t;if(!(0,d.ni)(n)||!(0,d.ni)(i))return(0,d.ks)("Invalid discoveryId or studentId");if("vote"!==o)return(0,d.ks)("Invalid action");if(i!==r.userId)return(0,d.Py)("Cannot vote on behalf of another user");let u=(0,d.bQ)();if("vote"===o){let{data:e,error:t}=await u.from("discovery_helpful").delete().eq("discovery_id",n).eq("student_id",i).select();if(t)throw t;if(e&&e.length>0)return await u.rpc("decrement_discovery_helpful",{p_discovery_id:n}),a.NextResponse.json({voted:!1});{let{error:e}=await u.from("discovery_helpful").insert({discovery_id:n,student_id:i});if(e){if("23505"===e.code)return a.NextResponse.json({voted:!0});throw e}return await u.rpc("increment_discovery_helpful",{p_discovery_id:n}),a.NextResponse.json({voted:!0})}}return(0,d.ks)("Invalid action")}catch(e){return console.error("[DISCOVERIES] PATCH error:",e instanceof Error?e.message:"Unknown"),(0,d.Vd)("Failed to update discovery")}}let p=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/discoveries/route",pathname:"/api/discoveries",filename:"route",bundlePath:"app/api/discoveries/route"},resolvedPagePath:"/workspace/leadership-platform/src/app/api/discoveries/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:f,staticGenerationAsyncStorage:h,serverHooks:_}=p,m="/api/discoveries/route";function y(){return(0,o.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:h})}},4596:(e,t,r)=>{r.d(t,{Cp:()=>I,Dn:()=>m,M2:()=>f,Py:()=>c,Vd:()=>p,bQ:()=>o,fp:()=>_,h3:()=>a,ks:()=>l,m:()=>u,ni:()=>v,oN:()=>d,tm:()=>y});var s=r(8635),n=r(2380);let i=null;function o(){if(i)return i;let e="https://apakkhzuydsfzvypewwa.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwYWtraHp1eWRzZnp2eXBld3dhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1MDEyODQsImV4cCI6MjA4NDA3NzI4NH0.c3hiZOEKMIXMP7aB0SVgrbQH58nwxseycVmeH23KsNQ";if(!e||!t)throw Error("FATAL: Missing Supabase configuration. Set NEXT_PUBLIC_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY environment variables.");return i=(0,n.eI)(e,t)}async function a(e){try{let t=o(),r=new URL(e.url),s=r.searchParams.get("studentId")||r.searchParams.get("userId");if(!s&&("POST"===e.method||"PATCH"===e.method))try{let t=await e.clone().json();s=t.studentId||t.student_id||t.userId||t.user_id||t.teacherId||t.teacher_id}catch{}if(!s)return{authenticated:!1,error:"No user identifier provided"};if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s))return{authenticated:!1,error:"Invalid user identifier format"};let{data:n,error:i}=await t.from("users").select("id, role, class_id").eq("id",s).single();if(i||!n)return{authenticated:!1,error:"User not found"};return{authenticated:!0,userId:n.id,role:n.role,classId:n.class_id}}catch(e){return console.error("[AUTH] Validation error:",e instanceof Error?e.message:"Unknown"),{authenticated:!1,error:"Authentication failed"}}}async function d(e,t){try{let r=o(),{data:s}=await r.from("users").select("class_id").eq("id",e).single();return s?.class_id===t}catch{return!1}}function u(e="Unauthorized"){return s.NextResponse.json({error:e},{status:401})}function c(e="Forbidden"){return s.NextResponse.json({error:e},{status:403})}function l(e){return s.NextResponse.json({error:e},{status:400})}function p(e="Internal server error"){return s.NextResponse.json({error:e},{status:500})}function f(e){return s.NextResponse.json({error:e},{status:503})}let h=new Map,_={ai:{windowMs:6e4,maxRequests:10},standard:{windowMs:6e4,maxRequests:60},write:{windowMs:6e4,maxRequests:30}};function m(e,t=_.standard){let r=Date.now();h.size>1e4&&h.forEach((e,t)=>{e.resetAt<r&&h.delete(t)});let s=h.get(e);return!s||s.resetAt<r?(h.set(e,{count:1,resetAt:r+t.windowMs}),{allowed:!0,remaining:t.maxRequests-1,resetIn:t.windowMs}):s.count>=t.maxRequests?{allowed:!1,remaining:0,resetIn:s.resetAt-r}:(s.count++,{allowed:!0,remaining:t.maxRequests-s.count,resetIn:s.resetAt-r})}function y(e){return s.NextResponse.json({error:"Too many requests. Please slow down."},{status:429,headers:{"Retry-After":String(Math.ceil(e/1e3)),"X-RateLimit-Reset":String(Math.ceil(e/1e3))}})}function v(e){return"string"==typeof e&&/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}function I(e,t=1e4){return"string"==typeof e&&e.length>0&&e.length<=t}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[469,16],()=>r(9691));module.exports=s})();