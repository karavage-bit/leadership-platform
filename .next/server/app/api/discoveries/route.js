"use strict";(()=>{var e={};e.id=839,e.ids=[839],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2615:e=>{e.exports=require("http")},5240:e=>{e.exports=require("https")},8216:e=>{e.exports=require("net")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},2452:e=>{e.exports=require("tls")},7360:e=>{e.exports=require("url")},1568:e=>{e.exports=require("zlib")},9691:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>_,patchFetch:()=>y,requestAsyncStorage:()=>f,routeModule:()=>p,serverHooks:()=>m,staticGenerationAsyncStorage:()=>h});var s={};r.r(s),r.d(s,{GET:()=>d,PATCH:()=>l,POST:()=>c});var i=r(9919),n=r(7665),o=r(8747),a=r(8635),u=r(4596);async function d(e){try{let t=await (0,u.h3)(e);if(!t.authenticated||!t.userId)return(0,u.m)(t.error);let{searchParams:r}=new URL(e.url),s=r.get("classId"),i=r.get("studentId")||t.userId,n=Math.min(parseInt(r.get("limit")||"20"),100);if(!s||!(0,u.ni)(s))return(0,u.ks)("Missing or invalid classId");if(!await (0,u.oN)(t.userId,s))return(0,u.Py)("You do not have access to this class");let o=(0,u.bQ)(),{data:d,error:c}=await o.from("student_discoveries").select(`
        id,
        student_id,
        title,
        source_type,
        source_name,
        content_url,
        description,
        leadership_connection,
        related_skills,
        image_url,
        helpful_count,
        comment_count,
        show_author,
        created_at,
        users!student_id (
          name,
          anonymous_name,
          is_unmasked
        )
      `).eq("class_id",s).eq("status","approved").order("created_at",{ascending:!1}).limit(n);if(c)throw c;let l=[];if(i){let{data:e}=await o.from("discovery_helpful").select("discovery_id").eq("student_id",i);l=e?.map(e=>e.discovery_id)||[]}let p=d?.map(e=>({id:e.id,authorName:e.show_author&&e.users?.is_unmasked?e.users?.name:e.users?.anonymous_name||"Anonymous",isUnmasked:e.show_author&&e.users?.is_unmasked,title:e.title,sourceType:e.source_type,sourceName:e.source_name,contentUrl:e.content_url,description:e.description,leadershipConnection:e.leadership_connection,relatedSkills:e.related_skills||[],imageUrl:e.image_url,helpfulCount:e.helpful_count||0,commentCount:e.comment_count||0,hasVoted:l.includes(e.id),createdAt:e.created_at}))||[];return a.NextResponse.json({discoveries:p})}catch(e){return console.error("[DISCOVERIES] GET error:",e instanceof Error?e.message:"Unknown"),(0,u.Vd)("Failed to fetch discoveries")}}async function c(e){try{let t;let r=await (0,u.h3)(e);if(!r.authenticated||!r.userId)return(0,u.m)(r.error);let s=(0,u.Dn)(`discovery:${r.userId}`,u.fp.write);if(!s.allowed)return(0,u.tm)(s.resetIn);try{t=await e.json()}catch{return(0,u.ks)("Invalid JSON body")}let{studentId:i,classId:n,title:o,sourceType:d,sourceName:c,contentUrl:l,description:p,leadershipConnection:f,relatedSkills:h,imageUrl:m}=t;if(!(0,u.ni)(i)||!(0,u.ni)(n))return(0,u.ks)("Invalid studentId or classId");if(!(0,u.Cp)(o,200)||!(0,u.Cp)(d,50))return(0,u.ks)("Invalid title or sourceType");if(!(0,u.Cp)(p,2e3)||!(0,u.Cp)(f,1e3))return(0,u.ks)("Invalid description or leadershipConnection");if(i!==r.userId)return(0,u.Py)("Cannot create discovery for another user");if(!await (0,u.oN)(r.userId,n))return(0,u.Py)("You do not have access to this class");let _=(0,u.bQ)(),{data:y,error:v}=await _.from("student_discoveries").insert({student_id:i,class_id:n,title:o.slice(0,200),source_type:d.slice(0,50),source_name:c?.slice(0,200),content_url:l?.slice(0,500),description:p.slice(0,2e3),leadership_connection:f.slice(0,1e3),related_skills:Array.isArray(h)?h.slice(0,10):[],image_url:m?.slice(0,500),status:"pending"}).select().single();if(v)throw v;return(async()=>{try{await _.rpc("add_to_feed",{p_class_id:n,p_student_id:i,p_activity_type:"discovery_posted",p_description:`Shared a discovery: "${o.slice(0,50)}"`,p_related_id:y.id,p_related_type:"discovery"})}catch(e){console.error("[DISCOVERIES] Feed insert failed:",e)}})(),a.NextResponse.json({success:!0,discovery:y,message:"Discovery submitted for review"})}catch(e){return console.error("[DISCOVERIES] POST error:",e instanceof Error?e.message:"Unknown"),(0,u.Vd)("Failed to create discovery")}}async function l(e){try{let t;let r=await (0,u.h3)(e);if(!r.authenticated||!r.userId)return(0,u.m)(r.error);let s=(0,u.Dn)(`vote:${r.userId}`,u.fp.write);if(!s.allowed)return(0,u.tm)(s.resetIn);try{t=await e.json()}catch{return(0,u.ks)("Invalid JSON body")}let{discoveryId:i,studentId:n,action:o}=t;if(!(0,u.ni)(i)||!(0,u.ni)(n))return(0,u.ks)("Invalid discoveryId or studentId");if("vote"!==o)return(0,u.ks)("Invalid action");if(n!==r.userId)return(0,u.Py)("Cannot vote on behalf of another user");let d=(0,u.bQ)();if("vote"===o){let{data:e,error:t}=await d.from("discovery_helpful").delete().eq("discovery_id",i).eq("student_id",n).select();if(t)throw t;if(e&&e.length>0)return await d.rpc("decrement_discovery_helpful",{p_discovery_id:i}),a.NextResponse.json({voted:!1});{let{error:e}=await d.from("discovery_helpful").insert({discovery_id:i,student_id:n});if(e){if("23505"===e.code)return a.NextResponse.json({voted:!0});throw e}return await d.rpc("increment_discovery_helpful",{p_discovery_id:i}),a.NextResponse.json({voted:!0})}}return(0,u.ks)("Invalid action")}catch(e){return console.error("[DISCOVERIES] PATCH error:",e instanceof Error?e.message:"Unknown"),(0,u.Vd)("Failed to update discovery")}}let p=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/discoveries/route",pathname:"/api/discoveries",filename:"route",bundlePath:"app/api/discoveries/route"},resolvedPagePath:"/workspace/leadership-platform/src/app/api/discoveries/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:f,staticGenerationAsyncStorage:h,serverHooks:m}=p,_="/api/discoveries/route";function y(){return(0,o.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:h})}},4596:(e,t,r)=>{r.d(t,{Cp:()=>I,Dn:()=>y,Gu:()=>u,M2:()=>h,Py:()=>l,Vd:()=>f,bQ:()=>o,fp:()=>_,h3:()=>a,ks:()=>p,m:()=>c,ni:()=>w,oN:()=>d,pG:()=>g,tm:()=>v,uw:()=>n,vJ:()=>x});var s=r(8635),i=r(2380);function n(e){let t="https://apakkhzuydsfzvypewwa.supabase.co",r="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwYWtraHp1eWRzZnp2eXBld3dhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1MDEyODQsImV4cCI6MjA4NDA3NzI4NH0.c3hiZOEKMIXMP7aB0SVgrbQH58nwxseycVmeH23KsNQ";if(!t||!r)throw Error("Missing Supabase configuration");let s=e.headers.get("Authorization");return(0,i.eI)(t,r,{global:{headers:s?{Authorization:s}:{}}})}let o=function(){let e="https://apakkhzuydsfzvypewwa.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Missing Supabase service configuration");return(0,i.eI)(e,t)};async function a(e){try{let t=n(e),{data:{user:r},error:s}=await t.auth.getUser();if(s||!r)return{authenticated:!1,error:"Invalid or expired session"};let{data:i,error:o}=await t.from("users").select("id, role, class_id").eq("id",r.id).single();if(o||!i)return{authenticated:!1,error:"User profile not found"};return{authenticated:!0,userId:r.id,role:i.role,classId:i.class_id}}catch(e){return console.error("[AUTH] Validation error:",e instanceof Error?e.message:"Unknown"),{authenticated:!1,error:"Authentication failed"}}}async function u(e){let t=await a(e);return t.authenticated&&"student"!==t.role?{authenticated:!1,error:"Student access required"}:t}async function d(e,t){let r=await a(e);if(!r.authenticated)return r;if("teacher"===r.role){let s=n(e),{data:i}=await s.from("classes").select("id").eq("id",t).eq("teacher_id",r.userId).single();if(!i)return{authenticated:!1,error:"Not authorized for this class"}}else if(r.classId!==t)return{authenticated:!1,error:"Not authorized for this class"};return r}function c(e="Unauthorized"){return s.NextResponse.json({error:e},{status:401})}function l(e="Forbidden"){return s.NextResponse.json({error:e},{status:403})}function p(e){return s.NextResponse.json({error:e},{status:400})}function f(e="Internal server error"){return s.NextResponse.json({error:e},{status:500})}function h(e){return s.NextResponse.json({error:e},{status:503})}let m=new Map,_={ai:{windowMs:6e4,maxRequests:10},standard:{windowMs:6e4,maxRequests:60},write:{windowMs:6e4,maxRequests:30}};function y(e,t=_.standard){let r=Date.now();m.size>1e4&&m.forEach((e,t)=>{e.resetAt<r&&m.delete(t)});let s=m.get(e);return!s||s.resetAt<r?(m.set(e,{count:1,resetAt:r+t.windowMs}),{allowed:!0,remaining:t.maxRequests-1,resetIn:t.windowMs}):s.count>=t.maxRequests?{allowed:!1,remaining:0,resetIn:s.resetAt-r}:(s.count++,{allowed:!0,remaining:t.maxRequests-s.count,resetIn:s.resetAt-r})}function v(e){return s.NextResponse.json({error:"Too many requests. Please slow down."},{status:429,headers:{"Retry-After":String(Math.ceil(e/1e3)),"X-RateLimit-Reset":String(Math.ceil(e/1e3))}})}function w(e){return"string"==typeof e&&/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}function I(e,t=5e3){if("string"!=typeof e)return!1;let r=e.trim();return r.length>0&&r.length<=t}function g(e){return"string"==typeof e&&["do_now","scenario","challenge","exit_ticket"].includes(e)}function x(e){return e.replace(/<[^>]*>/g,"").replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"").trim()}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[469,16],()=>r(9691));module.exports=s})();