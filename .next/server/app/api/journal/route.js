"use strict";(()=>{var e={};e.id=247,e.ids=[247],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2615:e=>{e.exports=require("http")},5240:e=>{e.exports=require("https")},8216:e=>{e.exports=require("net")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},2452:e=>{e.exports=require("tls")},7360:e=>{e.exports=require("url")},1568:e=>{e.exports=require("zlib")},4546:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>m,patchFetch:()=>_,requestAsyncStorage:()=>c,routeModule:()=>u,serverHooks:()=>h,staticGenerationAsyncStorage:()=>p});var s={};r.r(s),r.d(s,{GET:()=>d});var a=r(9919),i=r(7665),n=r(8747),o=r(8635),l=r(4596);async function d(e){try{let t=await (0,l.h3)(e);if(!t.authenticated||!t.userId)return(0,l.m)(t.error);let{searchParams:r}=new URL(e.url),s=r.get("studentId")||t.userId;if(!(0,l.ni)(s))return(0,l.ks)("Invalid studentId");if(s!==t.userId&&"teacher"!==t.role)return(0,l.Py)("Cannot view another student's journal");let a=(0,l.bQ)(),[{data:i},{data:n},{data:d},{data:u},{data:c},{data:p},{data:h},{data:m},{data:_}]=await Promise.all([a.from("gateway_challenges").select("completed_at, recipient_description").eq("student_id",s).eq("status","approved").single(),a.from("do_now_sessions").select("completed_at, lesson_id, lessons(skill_name)").eq("student_id",s).not("completed_at","is",null).order("completed_at",{ascending:!1}).limit(100),a.from("scenario_sessions").select("completed_at, lesson_id, lessons(skill_name)").eq("student_id",s).not("completed_at","is",null).order("completed_at",{ascending:!1}).limit(100),a.from("challenge_submissions").select("submitted_at, review_status, challenges(title), lessons(skill_name)").eq("student_id",s).eq("review_status","reviewed").order("submitted_at",{ascending:!1}).limit(100),a.from("help_requests").select("completed_at, title, category").eq("helper_id",s).eq("status","completed").order("completed_at",{ascending:!1}).limit(100),a.from("help_requests").select("completed_at, title, category").eq("requester_id",s).eq("status","completed").order("completed_at",{ascending:!1}).limit(100),a.from("student_discoveries").select("created_at, title, source_type, related_skills").eq("student_id",s).eq("status","approved").order("created_at",{ascending:!1}).limit(100),a.from("teacher_challenge_responses").select("submitted_at, teacher_challenges(title, related_skills)").eq("student_id",s).order("submitted_at",{ascending:!1}).limit(100),a.from("ripples").select("created_at, source_description, chain_position").eq("source_student_id",s).eq("chain_position",1).order("created_at",{ascending:!1}).limit(100)]),f=[];i?.completed_at&&f.push({id:"gateway",date:i.completed_at,type:"gateway",title:"Completed Gateway Challenge",description:`Sent gratitude to: ${i.recipient_description}`,reward:{type:"flower",amount:1}}),n?.forEach(e=>f.push({id:`donow-${e.lesson_id}`,date:e.completed_at,type:"do_now",title:"Completed Do Now",description:`Explored thoughts on ${e.lessons?.skill_name||"leadership"}`,skill:e.lessons?.skill_name,reward:{type:"flower",amount:1}})),d?.forEach(e=>f.push({id:`scenario-${e.lesson_id}`,date:e.completed_at,type:"scenario",title:"Completed Scenario",description:`Applied ${e.lessons?.skill_name||"skills"} to a real situation`,skill:e.lessons?.skill_name,reward:{type:"tree",amount:1}})),u?.forEach(e=>f.push({id:`challenge-${e.submitted_at}`,date:e.submitted_at,type:"challenge",title:e.challenges?.title||"Completed Challenge",description:`Proved ${e.lessons?.skill_name||"skills"} in real life`,skill:e.lessons?.skill_name,reward:{type:"tower",amount:1}})),c?.forEach(e=>f.push({id:`help-given-${e.completed_at}`,date:e.completed_at,type:"help_given",title:"Helped a Classmate",description:e.title,reward:{type:"bridge",amount:1}})),p?.forEach(e=>f.push({id:`help-received-${e.completed_at}`,date:e.completed_at,type:"help_received",title:"Received Help",description:e.title})),h?.forEach(e=>f.push({id:`discovery-${e.created_at}`,date:e.created_at,type:"discovery",title:`Shared: ${e.title}`,description:`Found leadership in ${e.source_type}`,skill:e.related_skills?.[0],reward:{type:"flower",amount:1}})),m?.forEach(e=>f.push({id:`teacher-${e.submitted_at}`,date:e.submitted_at,type:"teacher_challenge",title:e.teacher_challenges?.title||"Completed Challenge",description:"Responded to teacher challenge",skill:e.teacher_challenges?.related_skills?.[0],reward:{type:"flower",amount:1}})),_?.forEach(e=>f.push({id:`ripple-${e.created_at}`,date:e.created_at,type:"ripple",title:"Started a Ripple",description:e.source_description,reward:{type:"crystal",amount:1}})),f.sort((e,t)=>new Date(e.date).getTime()-new Date(t.date).getTime());let g=[],w=null;f.forEach(e=>{let t=new Date(e.date),r=new Date(t);r.setDate(r.getDate()-r.getDay()),r.setHours(0,0,0,0);let s=r.toISOString().split("T")[0];if(!w||w.weekStart!==s){w&&g.push(w);let e=new Date(r);e.setDate(e.getDate()+6),w={weekStart:s,weekEnd:e.toISOString().split("T")[0],entries:[],highlights:[]}}if(w.entries.push(e),e.reward){let t="tree"===e.reward.type?"\uD83C\uDF32":"flower"===e.reward.type?"\uD83C\uDF38":"tower"===e.reward.type?"\uD83C\uDFDB️":"bridge"===e.reward.type?"\uD83C\uDF09":"crystal"===e.reward.type?"\uD83D\uDC8E":"✨";w.highlights.includes(t)||w.highlights.push(t)}}),w&&g.push(w);let y=new Set(f.map(e=>new Date(e.date).toDateString())),q=y.size,x=0,k=0,I=Array.from(y).map(e=>new Date(e)).sort((e,t)=>e.getTime()-t.getTime());for(let e=0;e<I.length;e++)k=0===e?1:(I[e].getTime()-I[e-1].getTime())/864e5<=1?k+1:1,x=Math.max(x,k);let v=Array.from(new Set(f.filter(e=>e.skill).map(e=>e.skill)));return o.NextResponse.json({weeks:g.reverse(),totalDaysActive:q,longestStreak:x,totalRipples:_?.length||0,skillsLearned:v})}catch(e){return console.error("[JOURNAL] GET error:",e instanceof Error?e.message:"Unknown"),(0,l.Vd)("Failed to generate growth journal")}}let u=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/journal/route",pathname:"/api/journal",filename:"route",bundlePath:"app/api/journal/route"},resolvedPagePath:"/workspace/leadership-platform/src/app/api/journal/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:c,staticGenerationAsyncStorage:p,serverHooks:h}=u,m="/api/journal/route";function _(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:p})}},4596:(e,t,r)=>{r.d(t,{Cp:()=>x,Dn:()=>w,Gu:()=>d,M2:()=>_,Py:()=>p,Vd:()=>m,bQ:()=>o,fp:()=>g,h3:()=>l,ks:()=>h,m:()=>c,ni:()=>q,oN:()=>u,pG:()=>k,tm:()=>y,uw:()=>n,vJ:()=>I});var s=r(8635),a=r(2380);function i(){let e="https://apakkhzuydsfzvypewwa.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Missing Supabase service configuration");return(0,a.eI)(e,t)}function n(e){let t="https://apakkhzuydsfzvypewwa.supabase.co",r="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwYWtraHp1eWRzZnp2eXBld3dhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1MDEyODQsImV4cCI6MjA4NDA3NzI4NH0.c3hiZOEKMIXMP7aB0SVgrbQH58nwxseycVmeH23KsNQ";if(!t||!r)throw Error("Missing Supabase configuration");let s=e.headers.get("Authorization");return(0,a.eI)(t,r,{global:{headers:s?{Authorization:s}:{}}})}let o=i;async function l(e){try{let t=n(e),{data:{user:r},error:s}=await t.auth.getUser();if(s||!r)return{authenticated:!1,error:"Invalid or expired session"};let{data:a,error:i}=await t.from("users").select("id, role, class_id").eq("id",r.id).single();if(i||!a)return{authenticated:!1,error:"User profile not found"};return{authenticated:!0,userId:r.id,role:a.role,classId:a.class_id}}catch(e){return console.error("[AUTH] Validation error:",e instanceof Error?e.message:"Unknown"),{authenticated:!1,error:"Authentication failed"}}}async function d(e){let t=await l(e);if(t.authenticated)return"student"!==t.role?{authenticated:!1,error:"Student access required"}:t;try{let t=await e.clone().json(),r=t?.student_id;if(!r||!q(r))return{authenticated:!1,error:"Invalid or expired session"};let s=i(),{data:a,error:n}=await s.from("users").select("id, role, class_id").eq("id",r).eq("role","student").single();if(n||!a)return{authenticated:!1,error:"Student not found"};return{authenticated:!0,userId:a.id,role:"student",classId:a.class_id}}catch{return{authenticated:!1,error:"Authentication failed"}}}async function u(e,t){let r=await l(e);if(!r.authenticated)return r;if("teacher"===r.role){let s=n(e),{data:a}=await s.from("classes").select("id").eq("id",t).eq("teacher_id",r.userId).single();if(!a)return{authenticated:!1,error:"Not authorized for this class"}}else if(r.classId!==t)return{authenticated:!1,error:"Not authorized for this class"};return r}function c(e="Unauthorized"){return s.NextResponse.json({error:e},{status:401})}function p(e="Forbidden"){return s.NextResponse.json({error:e},{status:403})}function h(e){return s.NextResponse.json({error:e},{status:400})}function m(e="Internal server error"){return s.NextResponse.json({error:e},{status:500})}function _(e){return s.NextResponse.json({error:e},{status:503})}let f=new Map,g={ai:{windowMs:6e4,maxRequests:10},standard:{windowMs:6e4,maxRequests:60},write:{windowMs:6e4,maxRequests:30}};function w(e,t=g.standard){let r=Date.now();f.size>1e4&&f.forEach((e,t)=>{e.resetAt<r&&f.delete(t)});let s=f.get(e);return!s||s.resetAt<r?(f.set(e,{count:1,resetAt:r+t.windowMs}),{allowed:!0,remaining:t.maxRequests-1,resetIn:t.windowMs}):s.count>=t.maxRequests?{allowed:!1,remaining:0,resetIn:s.resetAt-r}:(s.count++,{allowed:!0,remaining:t.maxRequests-s.count,resetIn:s.resetAt-r})}function y(e){return s.NextResponse.json({error:"Too many requests. Please slow down."},{status:429,headers:{"Retry-After":String(Math.ceil(e/1e3)),"X-RateLimit-Reset":String(Math.ceil(e/1e3))}})}function q(e){return"string"==typeof e&&/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}function x(e,t=5e3){if("string"!=typeof e)return!1;let r=e.trim();return r.length>0&&r.length<=t}function k(e){return"string"==typeof e&&["do_now","scenario","challenge","exit_ticket"].includes(e)}function I(e){return e.replace(/<[^>]*>/g,"").replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"").trim()}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[469,16],()=>r(4546));module.exports=s})();