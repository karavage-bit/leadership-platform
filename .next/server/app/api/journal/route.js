"use strict";(()=>{var e={};e.id=247,e.ids=[247],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2615:e=>{e.exports=require("http")},5240:e=>{e.exports=require("https")},8216:e=>{e.exports=require("net")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},2452:e=>{e.exports=require("tls")},7360:e=>{e.exports=require("url")},1568:e=>{e.exports=require("zlib")},4546:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>_,requestAsyncStorage:()=>c,routeModule:()=>u,serverHooks:()=>m,staticGenerationAsyncStorage:()=>p});var s={};r.r(s),r.d(s,{GET:()=>d});var a=r(9919),i=r(7665),n=r(8747),o=r(8635),l=r(4596);async function d(e){try{let t=await (0,l.h3)(e);if(!t.authenticated||!t.userId)return(0,l.m)(t.error);let{searchParams:r}=new URL(e.url),s=r.get("studentId")||t.userId;if(!(0,l.ni)(s))return(0,l.ks)("Invalid studentId");if(s!==t.userId&&"teacher"!==t.role)return(0,l.Py)("Cannot view another student's journal");let a=(0,l.bQ)(),[{data:i},{data:n},{data:d},{data:u},{data:c},{data:p},{data:m},{data:h},{data:_}]=await Promise.all([a.from("gateway_challenges").select("completed_at, recipient_description").eq("student_id",s).eq("status","approved").single(),a.from("do_now_sessions").select("completed_at, lesson_id, lessons(skill_name)").eq("student_id",s).not("completed_at","is",null).order("completed_at",{ascending:!1}).limit(100),a.from("scenario_sessions").select("completed_at, lesson_id, lessons(skill_name)").eq("student_id",s).not("completed_at","is",null).order("completed_at",{ascending:!1}).limit(100),a.from("challenge_submissions").select("submitted_at, review_status, challenges(title), lessons(skill_name)").eq("student_id",s).eq("review_status","reviewed").order("submitted_at",{ascending:!1}).limit(100),a.from("help_requests").select("completed_at, title, category").eq("helper_id",s).eq("status","completed").order("completed_at",{ascending:!1}).limit(100),a.from("help_requests").select("completed_at, title, category").eq("requester_id",s).eq("status","completed").order("completed_at",{ascending:!1}).limit(100),a.from("student_discoveries").select("created_at, title, source_type, related_skills").eq("student_id",s).eq("status","approved").order("created_at",{ascending:!1}).limit(100),a.from("teacher_challenge_responses").select("submitted_at, teacher_challenges(title, related_skills)").eq("student_id",s).order("submitted_at",{ascending:!1}).limit(100),a.from("ripples").select("created_at, source_description, chain_position").eq("source_student_id",s).eq("chain_position",1).order("created_at",{ascending:!1}).limit(100)]),f=[];i?.completed_at&&f.push({id:"gateway",date:i.completed_at,type:"gateway",title:"Completed Gateway Challenge",description:`Sent gratitude to: ${i.recipient_description}`,reward:{type:"flower",amount:1}}),n?.forEach(e=>f.push({id:`donow-${e.lesson_id}`,date:e.completed_at,type:"do_now",title:"Completed Do Now",description:`Explored thoughts on ${e.lessons?.skill_name||"leadership"}`,skill:e.lessons?.skill_name,reward:{type:"flower",amount:1}})),d?.forEach(e=>f.push({id:`scenario-${e.lesson_id}`,date:e.completed_at,type:"scenario",title:"Completed Scenario",description:`Applied ${e.lessons?.skill_name||"skills"} to a real situation`,skill:e.lessons?.skill_name,reward:{type:"tree",amount:1}})),u?.forEach(e=>f.push({id:`challenge-${e.submitted_at}`,date:e.submitted_at,type:"challenge",title:e.challenges?.title||"Completed Challenge",description:`Proved ${e.lessons?.skill_name||"skills"} in real life`,skill:e.lessons?.skill_name,reward:{type:"tower",amount:1}})),c?.forEach(e=>f.push({id:`help-given-${e.completed_at}`,date:e.completed_at,type:"help_given",title:"Helped a Classmate",description:e.title,reward:{type:"bridge",amount:1}})),p?.forEach(e=>f.push({id:`help-received-${e.completed_at}`,date:e.completed_at,type:"help_received",title:"Received Help",description:e.title})),m?.forEach(e=>f.push({id:`discovery-${e.created_at}`,date:e.created_at,type:"discovery",title:`Shared: ${e.title}`,description:`Found leadership in ${e.source_type}`,skill:e.related_skills?.[0],reward:{type:"flower",amount:1}})),h?.forEach(e=>f.push({id:`teacher-${e.submitted_at}`,date:e.submitted_at,type:"teacher_challenge",title:e.teacher_challenges?.title||"Completed Challenge",description:"Responded to teacher challenge",skill:e.teacher_challenges?.related_skills?.[0],reward:{type:"flower",amount:1}})),_?.forEach(e=>f.push({id:`ripple-${e.created_at}`,date:e.created_at,type:"ripple",title:"Started a Ripple",description:e.source_description,reward:{type:"crystal",amount:1}})),f.sort((e,t)=>new Date(e.date).getTime()-new Date(t.date).getTime());let g=[],w=null;f.forEach(e=>{let t=new Date(e.date),r=new Date(t);r.setDate(r.getDate()-r.getDay()),r.setHours(0,0,0,0);let s=r.toISOString().split("T")[0];if(!w||w.weekStart!==s){w&&g.push(w);let e=new Date(r);e.setDate(e.getDate()+6),w={weekStart:s,weekEnd:e.toISOString().split("T")[0],entries:[],highlights:[]}}if(w.entries.push(e),e.reward){let t="tree"===e.reward.type?"\uD83C\uDF32":"flower"===e.reward.type?"\uD83C\uDF38":"tower"===e.reward.type?"\uD83C\uDFDB️":"bridge"===e.reward.type?"\uD83C\uDF09":"crystal"===e.reward.type?"\uD83D\uDC8E":"✨";w.highlights.includes(t)||w.highlights.push(t)}}),w&&g.push(w);let y=new Set(f.map(e=>new Date(e.date).toDateString())),q=y.size,I=0,k=0,x=Array.from(y).map(e=>new Date(e)).sort((e,t)=>e.getTime()-t.getTime());for(let e=0;e<x.length;e++)k=0===e?1:(x[e].getTime()-x[e-1].getTime())/864e5<=1?k+1:1,I=Math.max(I,k);let v=Array.from(new Set(f.filter(e=>e.skill).map(e=>e.skill)));return o.NextResponse.json({weeks:g.reverse(),totalDaysActive:q,longestStreak:I,totalRipples:_?.length||0,skillsLearned:v})}catch(e){return console.error("[JOURNAL] GET error:",e instanceof Error?e.message:"Unknown"),(0,l.Vd)("Failed to generate growth journal")}}let u=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/journal/route",pathname:"/api/journal",filename:"route",bundlePath:"app/api/journal/route"},resolvedPagePath:"/workspace/leadership-platform/src/app/api/journal/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:c,staticGenerationAsyncStorage:p,serverHooks:m}=u,h="/api/journal/route";function _(){return(0,n.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:p})}},4596:(e,t,r)=>{r.d(t,{Cp:()=>y,Dn:()=>f,M2:()=>m,Py:()=>u,Vd:()=>p,bQ:()=>n,fp:()=>_,h3:()=>o,ks:()=>c,m:()=>d,ni:()=>w,oN:()=>l,tm:()=>g});var s=r(8635),a=r(2380);let i=null;function n(){if(i)return i;let e="https://apakkhzuydsfzvypewwa.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwYWtraHp1eWRzZnp2eXBld3dhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1MDEyODQsImV4cCI6MjA4NDA3NzI4NH0.c3hiZOEKMIXMP7aB0SVgrbQH58nwxseycVmeH23KsNQ";if(!e||!t)throw Error("FATAL: Missing Supabase configuration. Set NEXT_PUBLIC_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY environment variables.");return i=(0,a.eI)(e,t)}async function o(e){try{let t=n(),r=new URL(e.url),s=r.searchParams.get("studentId")||r.searchParams.get("userId");if(!s&&("POST"===e.method||"PATCH"===e.method))try{let t=await e.clone().json();s=t.studentId||t.student_id||t.userId||t.user_id||t.teacherId||t.teacher_id}catch{}if(!s)return{authenticated:!1,error:"No user identifier provided"};if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s))return{authenticated:!1,error:"Invalid user identifier format"};let{data:a,error:i}=await t.from("users").select("id, role, class_id").eq("id",s).single();if(i||!a)return{authenticated:!1,error:"User not found"};return{authenticated:!0,userId:a.id,role:a.role,classId:a.class_id}}catch(e){return console.error("[AUTH] Validation error:",e instanceof Error?e.message:"Unknown"),{authenticated:!1,error:"Authentication failed"}}}async function l(e,t){try{let r=n(),{data:s}=await r.from("users").select("class_id").eq("id",e).single();return s?.class_id===t}catch{return!1}}function d(e="Unauthorized"){return s.NextResponse.json({error:e},{status:401})}function u(e="Forbidden"){return s.NextResponse.json({error:e},{status:403})}function c(e){return s.NextResponse.json({error:e},{status:400})}function p(e="Internal server error"){return s.NextResponse.json({error:e},{status:500})}function m(e){return s.NextResponse.json({error:e},{status:503})}let h=new Map,_={ai:{windowMs:6e4,maxRequests:10},standard:{windowMs:6e4,maxRequests:60},write:{windowMs:6e4,maxRequests:30}};function f(e,t=_.standard){let r=Date.now();h.size>1e4&&h.forEach((e,t)=>{e.resetAt<r&&h.delete(t)});let s=h.get(e);return!s||s.resetAt<r?(h.set(e,{count:1,resetAt:r+t.windowMs}),{allowed:!0,remaining:t.maxRequests-1,resetIn:t.windowMs}):s.count>=t.maxRequests?{allowed:!1,remaining:0,resetIn:s.resetAt-r}:(s.count++,{allowed:!0,remaining:t.maxRequests-s.count,resetIn:s.resetAt-r})}function g(e){return s.NextResponse.json({error:"Too many requests. Please slow down."},{status:429,headers:{"Retry-After":String(Math.ceil(e/1e3)),"X-RateLimit-Reset":String(Math.ceil(e/1e3))}})}function w(e){return"string"==typeof e&&/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}function y(e,t=1e4){return"string"==typeof e&&e.length>0&&e.length<=t}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[469,16],()=>r(4546));module.exports=s})();