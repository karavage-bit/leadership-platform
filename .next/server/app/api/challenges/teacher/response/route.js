"use strict";(()=>{var e={};e.id=613,e.ids=[613],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2615:e=>{e.exports=require("http")},5240:e=>{e.exports=require("https")},8216:e=>{e.exports=require("net")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},2452:e=>{e.exports=require("tls")},7360:e=>{e.exports=require("url")},1568:e=>{e.exports=require("zlib")},9978:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>w,patchFetch:()=>_,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>f,staticGenerationAsyncStorage:()=>h});var s={};r.r(s),r.d(s,{GET:()=>c,POST:()=>l});var n=r(9919),a=r(7665),i=r(8747),o=r(8635),u=r(4596);async function l(e){try{let t;let r=await (0,u.h3)(e);if(!r.authenticated||!r.userId)return(0,u.m)(r.error);let s=(0,u.Dn)(`response:${r.userId}`,u.fp.write);if(!s.allowed)return(0,u.tm)(s.resetIn);try{t=await e.json()}catch{return(0,u.ks)("Invalid JSON body")}let{challengeId:n,studentId:a,classId:i,responseText:l,personalConnection:c,shareWithClass:d}=t;if(!(0,u.ni)(n)||!(0,u.ni)(a)||!(0,u.ni)(i))return(0,u.ks)("Invalid IDs");if(!(0,u.Cp)(l,5e3))return(0,u.ks)("Invalid responseText");if(a!==r.userId)return(0,u.Py)("Cannot submit response for another user");let p=(0,u.bQ)(),{data:h,error:f}=await p.from("teacher_challenge_responses").insert({challenge_id:n,student_id:a,class_id:i,response_text:l.slice(0,5e3),personal_connection:c?.slice(0,2e3),share_with_class:d||!1,reward_granted:!0}).select().single();if(f){if("23505"===f.code)return o.NextResponse.json({error:"Already responded to this challenge"},{status:400});throw f}return(async()=>{try{let{data:e}=await p.from("teacher_challenges").select("reward_type, reward_amount, title").eq("id",n).single();if(e){let t="flower"===e.reward_type?"flowers":"tree"===e.reward_type?"trees":"crystal"===e.reward_type?"crystals":"flowers";await Promise.all([p.rpc("increment_world_resource",{p_student_id:a,p_resource:t,p_amount:e.reward_amount||1}),p.rpc("add_to_feed",{p_class_id:i,p_student_id:a,p_activity_type:"teacher_challenge_complete",p_description:`Completed challenge: "${e.title}"`,p_related_id:n,p_related_type:"teacher_challenge"}),p.rpc("increment_response_count",{p_challenge_id:n})])}}catch(e){console.error("[RESPONSE] Reward/feed failed:",e)}})(),o.NextResponse.json({success:!0,response:h})}catch(e){return console.error("[RESPONSE] POST error:",e instanceof Error?e.message:"Unknown"),(0,u.Vd)("Failed to submit response")}}async function c(e){try{let t=await (0,u.h3)(e);if(!t.authenticated||!t.userId)return(0,u.m)(t.error);let{searchParams:r}=new URL(e.url),s=r.get("challengeId"),n=r.get("studentId"),a="true"===r.get("teacherView");if(!s||!(0,u.ni)(s))return(0,u.ks)("Missing or invalid challengeId");let i=(0,u.bQ)();if(a){if("teacher"!==t.role)return(0,u.Py)("Only teachers can view all responses");let{data:e,error:r}=await i.from("teacher_challenge_responses").select("id, response_text, personal_connection, share_with_class, submitted_at, users!student_id (name, anonymous_name, is_unmasked)").eq("challenge_id",s).order("submitted_at",{ascending:!1}).limit(100);if(r)throw r;return o.NextResponse.json({responses:e})}if(n){if(n!==t.userId&&"teacher"!==t.role)return(0,u.Py)("Cannot view another student's response");let{data:e}=await i.from("teacher_challenge_responses").select("id, submitted_at").eq("challenge_id",s).eq("student_id",n).single();return o.NextResponse.json({responded:!!e,response:e})}return(0,u.ks)("Invalid request")}catch(e){return console.error("[RESPONSE] GET error:",e instanceof Error?e.message:"Unknown"),(0,u.Vd)("Failed to fetch responses")}}let d=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/challenges/teacher/response/route",pathname:"/api/challenges/teacher/response",filename:"route",bundlePath:"app/api/challenges/teacher/response/route"},resolvedPagePath:"/workspace/leadership-platform/src/app/api/challenges/teacher/response/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:p,staticGenerationAsyncStorage:h,serverHooks:f}=d,w="/api/challenges/teacher/response/route";function _(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:h})}},4596:(e,t,r)=>{r.d(t,{Cp:()=>I,Dn:()=>m,Gu:()=>l,M2:()=>w,Py:()=>p,Vd:()=>f,bQ:()=>o,fp:()=>g,h3:()=>u,ks:()=>h,m:()=>d,ni:()=>y,oN:()=>c,pG:()=>q,tm:()=>x,uw:()=>i,vJ:()=>R});var s=r(8635),n=r(2380);function a(){let e="https://apakkhzuydsfzvypewwa.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Missing Supabase service configuration");return(0,n.eI)(e,t)}function i(e){let t="https://apakkhzuydsfzvypewwa.supabase.co",r="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwYWtraHp1eWRzZnp2eXBld3dhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1MDEyODQsImV4cCI6MjA4NDA3NzI4NH0.c3hiZOEKMIXMP7aB0SVgrbQH58nwxseycVmeH23KsNQ";if(!t||!r)throw Error("Missing Supabase configuration");let s=e.headers.get("Authorization");return(0,n.eI)(t,r,{global:{headers:s?{Authorization:s}:{}}})}let o=a;async function u(e){try{let t=i(e),{data:{user:r},error:s}=await t.auth.getUser();if(s||!r)return{authenticated:!1,error:"Invalid or expired session"};let{data:n,error:a}=await t.from("users").select("id, role, class_id").eq("id",r.id).single();if(a||!n)return{authenticated:!1,error:"User profile not found"};return{authenticated:!0,userId:r.id,role:n.role,classId:n.class_id}}catch(e){return console.error("[AUTH] Validation error:",e instanceof Error?e.message:"Unknown"),{authenticated:!1,error:"Authentication failed"}}}async function l(e){let t=await u(e);if(t.authenticated)return"student"!==t.role?{authenticated:!1,error:"Student access required"}:t;try{let t=await e.clone().json(),r=t?.student_id;if(!r||!y(r))return{authenticated:!1,error:"Invalid or expired session"};let s=a(),{data:n,error:i}=await s.from("users").select("id, role, class_id").eq("id",r).eq("role","student").single();if(i||!n)return{authenticated:!1,error:"Student not found"};return{authenticated:!0,userId:n.id,role:"student",classId:n.class_id}}catch{return{authenticated:!1,error:"Authentication failed"}}}async function c(e,t){let r=await u(e);if(!r.authenticated)return r;if("teacher"===r.role){let s=i(e),{data:n}=await s.from("classes").select("id").eq("id",t).eq("teacher_id",r.userId).single();if(!n)return{authenticated:!1,error:"Not authorized for this class"}}else if(r.classId!==t)return{authenticated:!1,error:"Not authorized for this class"};return r}function d(e="Unauthorized"){return s.NextResponse.json({error:e},{status:401})}function p(e="Forbidden"){return s.NextResponse.json({error:e},{status:403})}function h(e){return s.NextResponse.json({error:e},{status:400})}function f(e="Internal server error"){return s.NextResponse.json({error:e},{status:500})}function w(e){return s.NextResponse.json({error:e},{status:503})}let _=new Map,g={ai:{windowMs:6e4,maxRequests:10},standard:{windowMs:6e4,maxRequests:60},write:{windowMs:6e4,maxRequests:30}};function m(e,t=g.standard){let r=Date.now();_.size>1e4&&_.forEach((e,t)=>{e.resetAt<r&&_.delete(t)});let s=_.get(e);return!s||s.resetAt<r?(_.set(e,{count:1,resetAt:r+t.windowMs}),{allowed:!0,remaining:t.maxRequests-1,resetIn:t.windowMs}):s.count>=t.maxRequests?{allowed:!1,remaining:0,resetIn:s.resetAt-r}:(s.count++,{allowed:!0,remaining:t.maxRequests-s.count,resetIn:s.resetAt-r})}function x(e){return s.NextResponse.json({error:"Too many requests. Please slow down."},{status:429,headers:{"Retry-After":String(Math.ceil(e/1e3)),"X-RateLimit-Reset":String(Math.ceil(e/1e3))}})}function y(e){return"string"==typeof e&&/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}function I(e,t=5e3){if("string"!=typeof e)return!1;let r=e.trim();return r.length>0&&r.length<=t}function q(e){return"string"==typeof e&&["do_now","scenario","challenge","exit_ticket"].includes(e)}function R(e){return e.replace(/<[^>]*>/g,"").replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"").trim()}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[469,16],()=>r(9978));module.exports=s})();