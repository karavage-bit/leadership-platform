"use strict";(()=>{var e={};e.id=692,e.ids=[692],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2615:e=>{e.exports=require("http")},5240:e=>{e.exports=require("https")},8216:e=>{e.exports=require("net")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},2452:e=>{e.exports=require("tls")},7360:e=>{e.exports=require("url")},1568:e=>{e.exports=require("zlib")},4829:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>g,patchFetch:()=>w,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>f,staticGenerationAsyncStorage:()=>h});var n={};r.r(n),r.d(n,{GET:()=>u,POST:()=>c});var a=r(9919),s=r(7665),i=r(8747),o=r(8635),l=r(4596);async function u(e){try{let t=await (0,l.h3)(e);if(!t.authenticated||!t.userId)return(0,l.m)(t.error);let{searchParams:r}=new URL(e.url),n=r.get("classId"),a=r.get("studentId")||t.userId;if(!n||!(0,l.ni)(n))return(0,l.ks)("Missing or invalid classId");if(!await (0,l.oN)(t.userId,n))return(0,l.Py)("You do not have access to this class");let s=(0,l.bQ)(),{data:i,error:u}=await s.from("teacher_challenges").select("*").eq("class_id",n).eq("is_active",!0).or(`available_until.is.null,available_until.gt.${new Date().toISOString()}`).order("created_at",{ascending:!1}).limit(50);if(u)throw u;let c=[];if(a&&(0,l.ni)(a)){let{data:e}=await s.from("teacher_challenge_responses").select("challenge_id").eq("student_id",a);c=e?.map(e=>e.challenge_id)||[]}let d=i?.map(e=>({id:e.id,title:e.title,type:e.challenge_type,contentUrl:e.content_url,contentDescription:e.content_description,prompt:e.prompt,relatedSkills:e.related_skills||[],rewardType:e.reward_type,rewardAmount:e.reward_amount,dueDate:e.available_until,completed:c.includes(e.id)}))||[];return o.NextResponse.json({challenges:d})}catch(e){return console.error("[CHALLENGES] GET error:",e instanceof Error?e.message:"Unknown"),(0,l.Vd)("Failed to fetch challenges")}}async function c(e){try{let t;let r=await (0,l.h3)(e);if(!r.authenticated||!r.userId)return(0,l.m)(r.error);if("teacher"!==r.role)return(0,l.Py)("Only teachers can create challenges");let n=(0,l.Dn)(`challenge:${r.userId}`,l.fp.write);if(!n.allowed)return(0,l.tm)(n.resetIn);try{t=await e.json()}catch{return(0,l.ks)("Invalid JSON body")}let{teacherId:a,classId:s,title:i,challengeType:u,contentUrl:c,contentDescription:d,prompt:p,relatedSkills:h,availableUntil:f,rewardType:g,rewardAmount:w}=t;if(!(0,l.ni)(s)||!(0,l.Cp)(i,200)||!(0,l.Cp)(u,50)||!(0,l.Cp)(p,2e3))return(0,l.ks)("Missing or invalid required fields");if(a&&a!==r.userId)return(0,l.Py)("Cannot create challenges as another teacher");let m=(0,l.bQ)(),{data:x,error:I}=await m.from("teacher_challenges").insert({teacher_id:r.userId,class_id:s,title:i.slice(0,200),challenge_type:u.slice(0,50),content_url:c?.slice(0,500),content_description:d?.slice(0,1e3),prompt:p.slice(0,2e3),related_skills:Array.isArray(h)?h.slice(0,10):[],available_until:f,reward_type:g||"flower",reward_amount:Math.min(w||1,10)}).select().single();if(I)throw I;return o.NextResponse.json({success:!0,challenge:x})}catch(e){return console.error("[CHALLENGES] POST error:",e instanceof Error?e.message:"Unknown"),(0,l.Vd)("Failed to create challenge")}}let d=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/challenges/teacher/route",pathname:"/api/challenges/teacher",filename:"route",bundlePath:"app/api/challenges/teacher/route"},resolvedPagePath:"/workspace/leadership-platform/src/app/api/challenges/teacher/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:p,staticGenerationAsyncStorage:h,serverHooks:f}=d,g="/api/challenges/teacher/route";function w(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:h})}},4596:(e,t,r)=>{r.d(t,{Cp:()=>_,Dn:()=>x,Gu:()=>u,M2:()=>g,Py:()=>p,Vd:()=>f,bQ:()=>o,fp:()=>m,h3:()=>l,ks:()=>h,m:()=>d,ni:()=>y,oN:()=>c,pG:()=>q,tm:()=>I,uw:()=>i,vJ:()=>v});var n=r(8635),a=r(2380);function s(){let e="https://apakkhzuydsfzvypewwa.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Missing Supabase service configuration");return(0,a.eI)(e,t)}function i(e){let t="https://apakkhzuydsfzvypewwa.supabase.co",r="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwYWtraHp1eWRzZnp2eXBld3dhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1MDEyODQsImV4cCI6MjA4NDA3NzI4NH0.c3hiZOEKMIXMP7aB0SVgrbQH58nwxseycVmeH23KsNQ";if(!t||!r)throw Error("Missing Supabase configuration");let n=e.headers.get("Authorization");return(0,a.eI)(t,r,{global:{headers:n?{Authorization:n}:{}}})}let o=s;async function l(e){try{let t=i(e),{data:{user:r},error:n}=await t.auth.getUser();if(n||!r)return{authenticated:!1,error:"Invalid or expired session"};let{data:a,error:s}=await t.from("users").select("id, role, class_id").eq("id",r.id).single();if(s||!a)return{authenticated:!1,error:"User profile not found"};return{authenticated:!0,userId:r.id,role:a.role,classId:a.class_id}}catch(e){return console.error("[AUTH] Validation error:",e instanceof Error?e.message:"Unknown"),{authenticated:!1,error:"Authentication failed"}}}async function u(e){let t=await l(e);if(t.authenticated)return"student"!==t.role?{authenticated:!1,error:"Student access required"}:t;try{let t=await e.clone().json(),r=t?.student_id;if(!r||!y(r))return{authenticated:!1,error:"Invalid or expired session"};let n=s(),{data:a,error:i}=await n.from("users").select("id, role, class_id").eq("id",r).eq("role","student").single();if(i||!a)return{authenticated:!1,error:"Student not found"};return{authenticated:!0,userId:a.id,role:"student",classId:a.class_id}}catch{return{authenticated:!1,error:"Authentication failed"}}}async function c(e,t){let r=await l(e);if(!r.authenticated)return r;if("teacher"===r.role){let n=i(e),{data:a}=await n.from("classes").select("id").eq("id",t).eq("teacher_id",r.userId).single();if(!a)return{authenticated:!1,error:"Not authorized for this class"}}else if(r.classId!==t)return{authenticated:!1,error:"Not authorized for this class"};return r}function d(e="Unauthorized"){return n.NextResponse.json({error:e},{status:401})}function p(e="Forbidden"){return n.NextResponse.json({error:e},{status:403})}function h(e){return n.NextResponse.json({error:e},{status:400})}function f(e="Internal server error"){return n.NextResponse.json({error:e},{status:500})}function g(e){return n.NextResponse.json({error:e},{status:503})}let w=new Map,m={ai:{windowMs:6e4,maxRequests:10},standard:{windowMs:6e4,maxRequests:60},write:{windowMs:6e4,maxRequests:30}};function x(e,t=m.standard){let r=Date.now();w.size>1e4&&w.forEach((e,t)=>{e.resetAt<r&&w.delete(t)});let n=w.get(e);return!n||n.resetAt<r?(w.set(e,{count:1,resetAt:r+t.windowMs}),{allowed:!0,remaining:t.maxRequests-1,resetIn:t.windowMs}):n.count>=t.maxRequests?{allowed:!1,remaining:0,resetIn:n.resetAt-r}:(n.count++,{allowed:!0,remaining:t.maxRequests-n.count,resetIn:n.resetAt-r})}function I(e){return n.NextResponse.json({error:"Too many requests. Please slow down."},{status:429,headers:{"Retry-After":String(Math.ceil(e/1e3)),"X-RateLimit-Reset":String(Math.ceil(e/1e3))}})}function y(e){return"string"==typeof e&&/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}function _(e,t=5e3){if("string"!=typeof e)return!1;let r=e.trim();return r.length>0&&r.length<=t}function q(e){return"string"==typeof e&&["do_now","scenario","challenge","exit_ticket"].includes(e)}function v(e){return e.replace(/<[^>]*>/g,"").replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"").trim()}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[469,16],()=>r(4829));module.exports=n})();